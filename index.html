<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Turnos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1 {
      color: #003366;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    /* --- BOTONES PRINCIPALES --- */
    .main-options {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    .main-options button {
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #00b3b3;
      color: white;
      transition: transform 0.2s, background 0.3s;
    }
    .main-options button:hover {
      background: #008080;
      transform: scale(1.05);
    }
    .main-options button.active {
      background: #003366;
    }

    /* --- TABS POR SEDE --- */
    .tabs {
      display: none;
      margin-bottom: 20px;
    }
    .tabs.active {
      display: block;
    }
    .tab-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab-buttons button {
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #eaeaea;
      transition: background 0.3s, transform 0.2s;
    }
    .tab-buttons button:hover {
      background: #92d6cf;
      transform: scale(1.05);
    }
    .tab-buttons button.active {
      background: #00b3b3;
      color: white;
    }

    /* --- CONTENIDO --- */
    .content-wrapper {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    /* --- BREADCRUMB CON TURNO --- */
    .breadcrumb-wrapper {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .breadcrumb {
      background: #f2f2f2;
      color: #003366;
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: bold;
      display: inline-block;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    .turnos-label {
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: bold;
      color: white;
      background-color: #00b3b3;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      transition: background 0.3s, transform 0.3s, opacity 0.3s;
    }
    .turnos-label.amarillo { background-color: #ffc107; color: #333; }
    .turnos-label.naranja { background-color: #ff9800; }
    .turnos-label.rojo { background-color: #dc3545; }

    /* Animaci√≥n de parpadeo */
    .animate {
      animation: parpadeo 0.5s;
    }
    @keyframes parpadeo {
      0% { opacity: 1; }
      50% { opacity: 0.2; }
      100% { opacity: 1; }
    }

    /* --- SELECT PISO --- */
    .piso-select {
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      display: inline-block;
    }

    /* --- TABLA --- */
    table {
      border-collapse: collapse;
      width: 500px;
      max-width: 90%;
      background: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    th, td {
      padding: 12px 20px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #0074b8;
      color: white;
      text-transform: uppercase;
    }
    tr:hover {
      background: #f1f1f1;
    }

    /* NOTA */
    .nota {
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>üìä Panel de Turnos</h1>

  <!-- OPCIONES PRINCIPALES -->
  <div class="main-options">
    <button onclick="mostrarTabs('farmacia')" id="btn-farmacia">Farmacia</button>
    <button onclick="mostrarTabs('usuario')" id="btn-usuario">Atenci√≥n al Usuario</button>
  </div>

  <!-- TABS FARMACIA -->
  <div id="tabs-farmacia" class="tabs">
    <div class="tab-buttons">
      <button onclick="mostrarTabla('116','farmacia')">116</button>
      <button onclick="mostrarTabla('Camp√≠n','farmacia')">Camp√≠n</button>
      <button onclick="mostrarTabla('Kennedy','farmacia')">Kennedy</button>
      <button onclick="mostrarTabla('Occidente','farmacia')">Occidente</button>
    </div>
    <div class="content-wrapper">
      <div>
        <div class="breadcrumb-wrapper">
          <p id="sede-actual-farmacia" class="breadcrumb">üè¢ Selecciona una sede</p>
          <p id="turnos-label-farmacia" class="turnos-label">Turnos en cola: 0</p>
        </div>
        <table id="data-table-farmacia">
          <thead>
            <tr>
              <th>√Årea</th>
              <th>Espera</th>
              <th>Atenci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3">Selecciona una sede</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TABS USUARIO -->
  <div id="tabs-usuario" class="tabs">
    <div class="tab-buttons">
      <button onclick="mostrarTabla('116','usuario')">116</button>
      <button onclick="mostrarTabla('Camp√≠n','usuario')">Camp√≠n</button>
      <button onclick="mostrarTabla('Kennedy','usuario')">Kennedy</button>
      <button onclick="mostrarTabla('Occidente','usuario')">Occidente</button>
    </div>
    <div class="content-wrapper">
      <div>
        <div class="breadcrumb-wrapper">
          <p id="sede-actual-usuario" class="breadcrumb">üè¢ Selecciona una sede</p>
          <span id="turnos-label-usuario" class="turnos-label">Turnos en cola: 0</span>
          <span id="piso-wrapper" style="display:none;">
            | <select id="select-piso-usuario" class="piso-select" onchange="actualizarBreadcrumb()">
              <option value="Sin selecci√≥n">Selecciona piso</option>
              <option value="1">Piso 1</option>
              <option value="2">Piso 2</option>
              <option value="3">Piso 3</option>
              <option value="4">Piso 4</option>
              <option value="5">Piso 5</option>
              <option value="6">Piso 6</option>
            </select>
          </span>
        </div>
        <table id="data-table-usuario">
          <thead>
            <tr>
              <th>√Årea</th>
              <th>Espera</th>
              <th>Atenci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3">Selecciona una sede</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <p class="nota">‚ö†Ô∏è La p√°gina de YNEXT solo permite visualizar hasta <b>50 turnos</b> a la vez.  
  Los adicionales no ser√°n visibles.</p>

  <script>
/* -------------------------
   Configuraci√≥n / globals
   ------------------------- */
var sedeActualUsuario = '';
var intervalId = null; // para evitar m√∫ltiples intervalos
var githubJsonUrl = "https://analista-bd.github.io/Servisalud-Panel/data/farmacia.json";

/* -------------------------
   Helpers
   ------------------------- */
// Normaliza un string: quita tildes, espacios y lo deja en min√∫sculas
function normalizeStr(s) {
  if (s === null || s === undefined) return "";
  try {
    return s.toString()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // quita diacr√≠ticos
            .replace(/\s+/g, '')             // quita espacios
            .toLowerCase();
  } catch (e) {
    return s.toString().replace(/\s+/g, '').toLowerCase();
  }
}

// Busca la clave correspondiente en los datos (soporta "Camp√≠n" <-> "Campin")
function findSedeKeyInData(sede, data) {
  if (!sede || !data) return null;
  // primer intento: coincidencia exacta
  if (data.hasOwnProperty(sede)) return sede;

  // si no, compara normalizando
  var norm = normalizeStr(sede);
  for (var k in data) {
    if (!data.hasOwnProperty(k)) continue;
    if (normalizeStr(k) === norm) return k;
  }
  return null;
}

/* -------------------------
   UI helpers
   ------------------------- */
function resetearBreadcrumbs() {
  // Reset farmacia
  var el = document.getElementById("sede-actual-farmacia");
  if (el) el.textContent = "üè¢ Selecciona una sede";
  var labF = document.getElementById("turnos-label-farmacia");
  if (labF) labF.textContent = "Turnos en cola: 0";
  var tbf = document.querySelector("#data-table-farmacia tbody");
  if (tbf) tbf.innerHTML = "<tr><td colspan='3'>Selecciona una sede</td></tr>";

  // Reset usuario
  var el2 = document.getElementById("sede-actual-usuario");
  if (el2) el2.textContent = "üè¢ Selecciona una sede";
  var labU = document.getElementById("turnos-label-usuario");
  if (labU) labU.textContent = "Turnos en cola: 0";
  var tbu = document.querySelector("#data-table-usuario tbody");
  if (tbu) tbu.innerHTML = "<tr><td colspan='3'>Selecciona una sede</td></tr>";

  var pw = document.getElementById("piso-wrapper");
  if (pw) pw.style.display = "none";
  var sp = document.getElementById("select-piso-usuario");
  if (sp) sp.value = "Sin selecci√≥n";

  sedeActualUsuario = "";
}

function mostrarTabs(tipo) {
  resetearBreadcrumbs();

  var tf = document.getElementById("tabs-farmacia");
  var tu = document.getElementById("tabs-usuario");
  var bf = document.getElementById("btn-farmacia");
  var bu = document.getElementById("btn-usuario");

  if (tf) tf.classList.remove("active");
  if (tu) tu.classList.remove("active");
  if (bf) bf.classList.remove("active");
  if (bu) bu.classList.remove("active");

  if (tipo === 'farmacia') {
    if (tf) tf.classList.add("active");
    if (bf) bf.classList.add("active");
  } else {
    if (tu) tu.classList.add("active");
    if (bu) bu.classList.add("active");
  }
}

/* -------------------------
   Petici√≥n al JSON publicado en GitHub
   ------------------------- */
async function fetchFromGitHub() {
  try {
    const resp = await fetch(githubJsonUrl, { cache: "no-store" }); // no usar cache
    if (!resp.ok) {
      throw new Error("Error al obtener JSON: " + resp.status + " " + resp.statusText);
    }
    const json = await resp.json();
    return json;
  } catch (err) {
    console.error("fetchFromGitHub:", err);
    throw err;
  }
}


/* -------------------------
   Carga y renderizado de datos
   ------------------------- */
async function cargarDatos(tablaId, labelId, sede) {
  try {
    // Obtener datos desde PowerAutomate
    const data = await fetchFromGitHub();

    // Buscar clave de sede dentro del JSON (maneja acentos/espacios)
    var sedeKey = findSedeKeyInData(sede, data);
    if (!sedeKey) {
      // Si no encontr√≥ la sede, mostrar mensaje en tabla
      var tbodyNo = document.querySelector(`#${tablaId} tbody`);
      if (tbodyNo) tbodyNo.innerHTML = "<tr><td colspan='3'>‚ùå No hay datos para esta sede</td></tr>";
      return;
    }

    var sedeData = data[sedeKey];
    var tbody = document.querySelector(`#${tablaId} tbody`);
    if (!tbody) return;
    tbody.innerHTML = "";

    // Recorremos las claves de la sede (ej G,H,AE) y evitamos la clave "total"
    Object.keys(sedeData).forEach(function(key) {
      if (key === "total") return; // omitimos fila total en el detalle
      var item = sedeData[key];
      if (item && typeof item === "object" && item.espera !== undefined) {
        var row = "<tr>" +
                  "<td><b>" + key + "</b></td>" +
                  "<td>" + (item.espera != null ? item.espera : "") + "</td>" +
                  "<td>" + (item.atencion != null ? item.atencion : "") + "</td>" +
                  "</tr>";
        tbody.innerHTML += row;
      }
    });

    // Actualizar label de turnos con animaci√≥n (tomamos sedeData.total.cola)
    if (sedeData.total && sedeData.total.cola !== undefined) {
      var cola = sedeData.total.cola;
      var label = document.getElementById(labelId);
      if (label) {
        label.textContent = "Turnos en cola: " + cola;
        // reset de clases (dejamos la base 'turnos-label')
        label.className = "turnos-label";
        if (cola <= 20) {
          // mantener fondo por defecto (no necesita clase adicional)
        } else if (cola <= 39) {
          label.classList.add("amarillo");
        } else if (cola <= 54) {
          label.classList.add("naranja");
        } else {
          label.classList.add("rojo");
        }
        // animaci√≥n breve
        label.classList.add("animate");
        setTimeout(function(){ label.classList.remove("animate"); }, 500);
      }
    }

  } catch (error) {
    console.error("cargarDatos:", error);
    var tbodyErr = document.querySelector(`#${tablaId} tbody`);
    if (tbodyErr) tbodyErr.innerHTML = "<tr><td colspan='3'>‚ùå Error al cargar datos</td></tr>";
  }
}

/* -------------------------
   Mostrar tabla / control de timer
   ------------------------- */
function mostrarTabla(sede, tipo) {
  var tablaId = tipo === "farmacia" ? "data-table-farmacia" : "data-table-usuario";
  var labelId = tipo === "farmacia" ? "turnos-label-farmacia" : "turnos-label-usuario";
  var sedeLabelId = tipo === "farmacia" ? "sede-actual-farmacia" : "sede-actual-usuario";

  var sedeLabelEl = document.getElementById(sedeLabelId);
  if (sedeLabelEl) sedeLabelEl.textContent = "üè¢ " + (tipo === 'farmacia' ? 'Farmacia' : 'Atenci√≥n al Usuario') + " > Sede " + sede;

  if (tipo === 'usuario') {
    sedeActualUsuario = sede;
    var pw = document.getElementById('piso-wrapper');
    if (pw) pw.style.display = 'inline-block';
  }

  // limpiar intervalos anteriores
  if (intervalId) {
    clearInterval(intervalId);
    intervalId = null;
  }

  // carga inicial y programada
  cargarDatos(tablaId, labelId, sede);
  intervalId = setInterval(function() { cargarDatos(tablaId, labelId, sede); }, 5000);
}

/* -------------------------
   Breadcrumb piso
   ------------------------- */
function actualizarBreadcrumb() {
  var piso = document.getElementById('select-piso-usuario').value;
  var target = document.getElementById('sede-actual-usuario');
  if (!target) return;
  if (piso === "Sin selecci√≥n") {
    target.textContent = "üè¢ Atenci√≥n al Usuario > Sede " + sedeActualUsuario;
  } else {
    target.textContent = "üè¢ Atenci√≥n al Usuario > Sede " + sedeActualUsuario + " | Piso " + piso;
  }
}
</script>

</body>
</html>
